Vagrant.configure(2) do |config|
  config.vm.box = "ubuntu/focal64"
  config.vm.synced_folder ".", "/vagrant", disabled: true
  config.ssh.insert_key = false

  config.vm.define :targetVM1 do |node|
    node.vm.network :private_network, ip: "192.168.5.5"
    node.vm.provision :file, source: "vxlan_hp.py", destination: "vxlan_hp.py"
    node.vm.provision :file, source: "vxlan_hp.c", destination: "vxlan_hp.c"
    node.vm.provision :shell, inline: <<-SHELL
      sudo apt -y update
      sudo apt install net-tools
      sudo apt install iftop
      ip link add vxlan1 type vxlan id 100 dstport 4789 srcport 4789 4790
      ip addr add 192.168.5.5/24 dev vxlan1
      ip link set up vxlan1
    SHELL
  end

  config.vm.define :targetVM2 do |node|
    node.vm.network :private_network, ip: "192.168.5.6"
    node.vm.provision :file, source: "vxlan_hp.py", destination: "vxlan_hp.py"
    node.vm.provision :file, source: "vxlan_hp.c", destination: "vxlan_hp.c"
    node.vm.provision :shell, inline: <<-SHELL
      sudo apt -y update
      sudo apt install net-tools
      sudo apt install iftop
      ip link add vxlan1 type vxlan id 200 dstport 4789 srcport 4789 4790
      ip addr add 192.168.5.6/24 dev vxlan1
      ip link set up vxlan1
    SHELL
  end
end